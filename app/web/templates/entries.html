{% extends "base.html" %}

{% block title %}Entries - Journal Monitor{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Recent Entries</h1>
    <div class="page-actions">
        <form method="get" action="/entries" class="sort-form" id="filter-form">
            <label class="sort-label">Type</label>
            <div class="multi-select-dropdown" id="type-dropdown">
                <button type="button" class="multi-select-trigger sort-select" onclick="toggleTypeDropdown(event)">
                    <span class="multi-select-text">{% if type_filter %}{{ type_filter|length }} selected{% else %}All types{% endif %}</span>
                    <span class="multi-select-arrow">▼</span>
                </button>
                <div class="multi-select-menu hidden" id="type-menu">
                    <div class="multi-select-actions">
                        <button type="button" class="btn btn-xs" onclick="selectAllTypes()">Select All</button>
                        <button type="button" class="btn btn-xs" onclick="clearAllTypes()">Clear All</button>
                    </div>
                    <div class="multi-select-options">
                        {% for t in valid_types %}
                        <label class="multi-select-option">
                            <input type="checkbox" name="type_filter" value="{{ t }}" {% if t in type_filter %}checked{% endif %} onchange="updateTypeFilterText()">
                            <span class="badge badge-type badge-type-{{ t }}">{{ t }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="multi-select-footer">
                        <button type="button" class="btn btn-xs btn-primary" onclick="applyTypeFilter()">Apply</button>
                    </div>
                </div>
            </div>
            <label for="subscription_id" class="sort-label">Journal</label>
            <select id="subscription_id" name="subscription_id" class="sort-select" onchange="this.form.submit()">
                <option value="">All journals</option>
                {% for subscription in subscriptions %}
                    <option value="{{ subscription.id }}" {% if subscription_id == subscription.id %}selected{% endif %}>
                        {{ subscription.name }}
                    </option>
                {% endfor %}
            </select>
            <label for="sort" class="sort-label">Sort</label>
            <select id="sort" name="sort" class="sort-select" onchange="this.form.submit()">
                <option value="fetched" {% if sort == 'fetched' %}selected{% endif %}>By fetched time</option>
                <option value="published" {% if sort == 'published' %}selected{% endif %}>By published time</option>
                <option value="journal" {% if sort == 'journal' %}selected{% endif %}>By journal</option>
            </select>
            <input type="hidden" name="page" value="{{ page }}" />
            <input type="hidden" name="page_size" value="{{ page_size or 10 }}" />
            {% for tag in tag_filter %}
            <input type="hidden" name="tag_filter" value="{{ tag }}" />
            {% endfor %}
            <noscript><button type="submit">Apply</button></noscript>
        </form>
    </div>
</div>

{% if tag_filter %}
<div class="active-filters">
    <span class="filter-label">Filtering by tags:</span>
    {% for tag in tag_filter %}
    <span class="badge badge-tag badge-tag-active">{{ tag }}</span>
    {% endfor %}
    <a href="/entries?sort={{ sort }}&page_size={{ page_size }}{% if subscription_id %}&subscription_id={{ subscription_id }}{% endif %}{% for t in type_filter %}&type_filter={{ t }}{% endfor %}" class="btn btn-xs">Clear tag filter</a>
</div>
{% endif %}

{% if entries %}
<div class="entries-list">
    {% for entry in entries %}
    <div class="entry-card" data-entry-id="{{ entry.id }}">
        <div class="entry-header">
            <div class="entry-header-left">
                {% set effective_type = entry.type_info.effective_type if entry.type_info else (entry.structured.site_type if entry.structured else 'other') %}
                <span class="badge badge-type badge-type-{{ effective_type }}" data-type-badge title="Article type: {{ effective_type }}{% if entry.type_info and entry.type_info.user_type %} (user override){% elif entry.type_info and entry.type_info.llm_type %} (LLM){% elif entry.type_info and entry.type_info.parse_type %} (parse){% endif %}">{{ effective_type }}</span>
                <a href="{{ entry.link }}" target="_blank" class="entry-title">{{ entry.title }}</a>
            </div>
            {% if entry.notified %}
                <span class="badge badge-notified">Notified</span>
            {% endif %}
        </div>
        <div class="entry-meta">
            <span class="entry-journal">
                {% if entry.subscription and entry.subscription.name %}
                    {{ entry.subscription.name }}
                {% elif entry.journal_name %}
                    {{ entry.journal_name }}
                {% else %}
                    Unknown journal
                {% endif %}
            </span>
            {% if entry.doi %}
                <span class="entry-doi">DOI: {{ entry.doi }}</span>
            {% endif %}
            {% if entry.authors %}
                <span class="entry-authors">{{ entry.authors[:100] }}{% if entry.authors|length > 100 %}...{% endif %}</span>
            {% endif %}
        </div>
        <div class="entry-footer">
            {% if entry.published_at %}
                <span class="entry-date {% if today_date and entry.published_at.date() == today_date %}entry-date-today{% endif %}">
                    Published: {{ entry.published_at.strftime('%Y-%m-%d') }}
                </span>
            {% endif %}
            <span class="entry-fetched">Fetched: {{ entry.fetched_at.strftime('%Y-%m-%d %H:%M') }}</span>
            <div style="flex: 1;"></div> <!-- Spacer -->
            {% if parse_enabled and logged_in %}
                {% if entry.content %}
                    <span class="badge badge-parse" title="Content via {{ entry.content.provider }}: {{ entry.content.text|length if entry.content.text else 0 }} chars">Parse ✓ ({{ entry.content.provider }})</span>
                    {% if llm_configured %}
                        {% if entry.structured %}
                            <span class="badge badge-llm" title="Type: {{ entry.structured.site_type }}">LLM ✓</span>
                        {% else %}
                            <button class="btn btn-xs btn-llm" onclick="fetchLlm({{ entry.id }}, this)" title="Extract structure via LLM">LLM</button>
                        {% endif %}
                    {% endif %}
                    <button class="btn btn-xs btn-preview" onclick="openPreview({{ entry.id }}, {{ 'true' if entry.structured else 'false' }})" title="Preview content">Preview</button>
                {% else %}
                    <button class="btn btn-xs btn-parse" onclick="fetchParse({{ entry.id }}, this)" title="Fetch content via parse providers">Parse</button>
                    {% if llm_configured %}
                        <button class="btn btn-xs btn-llm" disabled title="Fetch content first">LLM</button>
                    {% endif %}
                    <button class="btn btn-xs btn-preview" disabled title="Fetch content first to enable preview">Preview</button>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="pagination">
    <div class="pagination-info">
        Page {{ page }} / {{ total_pages }} ({{ total_entries }} entries)
    </div>
    <div class="pagination-actions">
        {% if page > 1 %}
            <a class="btn btn-sm" href="#" data-page="{{ page - 1 }}" data-direction="prev" onclick="navigatePage({{ page - 1 }}); return false;">Previous</a>
        {% else %}
            <span class="btn btn-sm" style="opacity:0.5;cursor:not-allowed;">Previous</span>
        {% endif %}

        {% if page < total_pages %}
            <a class="btn btn-sm btn-primary" href="#" data-page="{{ page + 1 }}" data-direction="next" onclick="navigatePage({{ page + 1 }}); return false;">Next</a>
        {% else %}
            <span class="btn btn-sm btn-primary" style="opacity:0.5;cursor:not-allowed;">Next</span>
        {% endif %}
    </div>
</div>
{% else %}
<div class="empty-state">
    <p>No entries yet. Add some subscriptions and run a check!</p>
</div>
{% endif %}

<!-- Preview Drawer -->
<div id="preview-backdrop" class="preview-backdrop" onclick="closePreview()"></div>
<div id="preview-drawer" class="preview-drawer" role="dialog" aria-modal="true" aria-labelledby="preview-title">
    <div class="preview-header">
        <h2 id="preview-title">Preview</h2>
        <button id="preview-close-btn" class="close-btn" onclick="closePreview()" title="Close (Esc)" aria-label="Close preview">&times;</button>
    </div>
    <div id="preview-content" class="preview-content">
        <!-- Content loaded dynamically -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Markdown renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Configure marked for safe rendering
marked.setOptions({
    breaks: true,  // Convert \n to <br>
    gfm: true,     // GitHub Flavored Markdown
});

// Multi-select dropdown functions
function toggleTypeDropdown(event) {
    event.stopPropagation();
    const menu = document.getElementById('type-menu');
    menu.classList.toggle('hidden');
}

function closeTypeDropdown() {
    const menu = document.getElementById('type-menu');
    if (menu) menu.classList.add('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('type-dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        closeTypeDropdown();
    }
});

function getSelectedTypes() {
    const checkboxes = document.querySelectorAll('#type-menu input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateTypeFilterText() {
    const selected = getSelectedTypes();
    const textSpan = document.querySelector('.multi-select-text');
    if (selected.length === 0) {
        textSpan.textContent = 'All types';
    } else if (selected.length === 1) {
        textSpan.textContent = selected[0];
    } else {
        textSpan.textContent = selected.length + ' selected';
    }
}

function selectAllTypes() {
    const checkboxes = document.querySelectorAll('#type-menu input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateTypeFilterText();
}

function clearAllTypes() {
    const checkboxes = document.querySelectorAll('#type-menu input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateTypeFilterText();
}

function applyTypeFilter() {
    closeTypeDropdown();
    submitFilterForm();
}

function submitFilterForm() {
    // Reset to page 1 when filters change
    const form = document.getElementById('filter-form');
    const pageInput = form.querySelector('input[name="page"]');
    if (pageInput) pageInput.value = '1';
    form.submit();
}

function navigatePage(page) {
    const form = document.getElementById('filter-form');
    const pageInput = form.querySelector('input[name="page"]');
    if (pageInput) pageInput.value = page;
    form.submit();
}

async function fetchParse(entryId, btn) {
    btn.disabled = true;
    btn.textContent = '...';
    try {
        const data = await apiCall(`/api/parse/fetch/${entryId}`, { method: 'POST' });
        btn.textContent = `Parse ✓ (${data.provider})`;
        btn.className = 'badge badge-parse';
        btn.onclick = null;
        btn.title = `Content via ${data.provider}: ${data.text_length} chars`;

        // Enable the LLM button next to it (if present)
        const llmBtn = btn.nextElementSibling;
        if (llmBtn && llmBtn.classList.contains('btn-llm')) {
            llmBtn.disabled = false;
            llmBtn.onclick = () => fetchLlm(entryId, llmBtn);
            llmBtn.title = 'Extract structure via LLM';
        }

        // Enable the Preview button
        const previewBtn = llmBtn ? llmBtn.nextElementSibling : btn.nextElementSibling;
        if (previewBtn && previewBtn.classList.contains('btn-preview')) {
            previewBtn.disabled = false;
            previewBtn.onclick = () => openPreview(entryId, false);
            previewBtn.title = 'Preview content';
        }
    } catch (error) {
        btn.disabled = false;
        btn.textContent = 'Parse';
        alert('Failed to fetch: ' + error.message);
    }
}

// Legacy alias for backward compatibility
async function fetchExa(entryId, btn) {
    return fetchParse(entryId, btn);
}

async function fetchLlm(entryId, btn) {
    btn.disabled = true;
    btn.textContent = '...';
    try {
        const data = await apiCall(`/api/llm/struct/${entryId}`, { method: 'POST' });
        btn.textContent = 'LLM ✓';
        btn.className = 'badge badge-llm';
        btn.onclick = null;
        btn.title = `Type: ${data.site_type}`;
    } catch (error) {
        btn.disabled = false;
        btn.textContent = 'LLM';
        alert('Failed to extract: ' + error.message);
    }
}

// Preview drawer functions
async function openPreview(entryId, hasStructured = false) {
    const backdrop = document.getElementById('preview-backdrop');
    const drawer = document.getElementById('preview-drawer');
    const content = document.getElementById('preview-content');
    const title = document.getElementById('preview-title');
    const closeBtn = document.getElementById('preview-close-btn');

    // Show loading state
    title.textContent = 'Loading...';
    content.innerHTML = '<div class="preview-loading">Loading preview...</div>';
    
    // Open drawer with animation
    document.body.classList.add('preview-open');
    backdrop.classList.add('is-open');
    drawer.classList.add('is-open');
    
    // Focus close button for accessibility
    setTimeout(() => closeBtn.focus(), 100);

    try {
        // Fetch parsed content
        const parseData = await apiCall(`/api/entries/${entryId}/parse/preview`);
        title.textContent = parseData.entry_title || 'Preview';

        // Fetch LLM structured info if available (ignore errors if missing)
        let llmData = null;
        try {
            llmData = await apiCall(`/api/entries/${entryId}/llm/preview`);
        } catch (e) {
            // LLM data not available or not configured; ignore.
        }

        // Fetch type info (ignore errors if missing)
        let typeData = null;
        try {
            typeData = await apiCall(`/api/entries/${entryId}/type`);
        } catch (e) {
            // Type info not available; ignore.
        }

        // Fetch tags (public endpoint, ignore errors)
        let tagsData = null;
        try {
            tagsData = await apiCall(`/api/entries/${entryId}/tags`);
        } catch (e) {
            // Tags not available; ignore.
        }

        content.innerHTML = renderPreviewContent(parseData, llmData, typeData, tagsData, entryId);
    } catch (error) {
        title.textContent = 'Error';
        content.innerHTML = `<div class="preview-error">Failed to load preview: ${error.message}</div>`;
    }
}

function renderPreviewContent(parseData, llmData, typeData, tagsData, entryId) {
    let html = '';
    const isLoggedIn = {{ 'true' if logged_in else 'false' }};

    // Tags section (always show)
    html += '<div class="preview-section preview-tags-section">';
    html += '<div class="preview-section-header">';
    html += '<span class="preview-text-header">Tags</span>';
    html += '</div>';
    html += '<div class="preview-meta">';
    
    const tags = tagsData?.tags || [];
    if (tags.length > 0) {
        html += '<div class="preview-tags-list">';
        for (const tag of tags) {
            if (isLoggedIn) {
                html += `<span class="tag-chip">`;
                html += `<a href="/entries?tag_filter=${encodeURIComponent(tag.key)}" class="badge badge-tag">${escapeHtml(tag.name)}</a>`;
                html += `<button type="button" class="tag-remove-btn" onclick="removeTag(${entryId}, '${escapeHtml(tag.key)}')" title="Remove tag" aria-label="Remove tag">×</button>`;
                html += `</span>`;
            } else {
                html += `<a href="/entries?tag_filter=${encodeURIComponent(tag.key)}" class="badge badge-tag">${escapeHtml(tag.name)}</a>`;
            }
        }
        html += '</div>';
    } else {
        html += '<div class="preview-meta-item hint">No tags assigned</div>';
    }
    
    if (isLoggedIn) {
        // Tag adder
        html += '<div class="preview-meta-item preview-tags-editor">';
        html += '<strong>Add Tag:</strong>';
        html += `<input type="text" id="tags-input-${entryId}" class="tags-input" placeholder="e.g. ml, vision (comma separated)">`;
        html += `<button class="btn btn-xs btn-primary" onclick="addTags(${entryId})">Add</button>`;
        html += '</div>';
    }
    
    html += '</div>';
    html += '</div>';

    // Article Type Classification section (always show)
    html += '<div class="preview-section preview-type-section">';
    html += '<div class="preview-section-header">';
    html += '<span class="preview-text-header">Article Type</span>';
    html += '</div>';
    html += '<div class="preview-meta">';
    
    const validTypes = typeData?.valid_types || ['blog', 'dataset', 'docs', 'forum', 'journal', 'news', 'other', 'paper', 'product', 'repository'];
    const effectiveType = typeData?.effective_type || 'other';
    const userType = typeData?.user_type || '';
    const llmType = typeData?.llm_type || '';
    const parseType = typeData?.parse_type || '';
    
    // Effective type display
    html += `<div class="preview-meta-item"><strong>Effective Type:</strong> <span class="badge badge-type badge-type-${effectiveType}">${effectiveType}</span>`;
    if (userType) {
        html += ' <span class="hint">(user override)</span>';
    } else if (llmType) {
        html += ' <span class="hint">(from LLM)</span>';
    } else if (parseType) {
        html += ' <span class="hint">(from parse)</span>';
    }
    html += '</div>';
    
    // Type sources breakdown
    if (parseType) {
        html += `<div class="preview-meta-item"><strong>Parse:</strong> ${parseType}`;
        if (typeData?.parse_reason) {
            html += ` <span class="hint">(${escapeHtml(typeData.parse_reason)})</span>`;
        }
        html += '</div>';
    }
    if (llmType) {
        html += `<div class="preview-meta-item"><strong>LLM:</strong> ${llmType}`;
        if (typeData?.llm_reason) {
            html += ` <span class="hint">(${escapeHtml(typeData.llm_reason)})</span>`;
        }
        html += '</div>';
    }
    if (userType) {
        html += `<div class="preview-meta-item"><strong>User:</strong> ${userType}`;
        if (typeData?.user_reason) {
            html += ` <span class="hint">(${escapeHtml(typeData.user_reason)})</span>`;
        }
        html += '</div>';
    }
    
    // Type editor
    html += '<div class="preview-meta-item preview-type-editor">';
    html += '<strong>Override:</strong> ';
    html += `<select id="type-select-${entryId}" class="type-select">`;
    html += `<option value="">-- No override --</option>`;
    for (const t of validTypes) {
        const selected = (userType === t) ? 'selected' : '';
        html += `<option value="${t}" ${selected}>${t}</option>`;
    }
    html += '</select>';
    html += `<input type="text" id="type-reason-${entryId}" class="type-reason-input" placeholder="Reason (optional)" value="${escapeHtml(typeData?.user_reason || '')}">`;
    html += `<button class="btn btn-xs btn-primary" onclick="saveUserType(${entryId})">Save</button>`;
    if (userType) {
        html += `<button class="btn btn-xs btn-danger" onclick="clearUserType(${entryId})">Clear</button>`;
    }
    html += '</div>';
    
    html += '</div>';
    html += '</div>';

    // LLM Structured Summary section (if available)
    if (llmData) {
        html += '<div class="preview-section preview-structured">';
        html += '<div class="preview-section-header">';
        html += '<span class="preview-text-header">LLM Summary</span>';
        html += `<button class="btn btn-xs" onclick="rerunLlm(${entryId})" title="Re-run LLM extraction">Re-run</button>`;
        html += '</div>';
        html += '<div class="preview-meta">';
        if (llmData.model) {
            html += `<div class="preview-meta-item"><strong>Model:</strong> ${escapeHtml(llmData.model)}</div>`;
        }
        html += '</div>';
        if (llmData.summary) {
            html += `<div class="preview-summary preview-markdown">${marked.parse(llmData.summary)}</div>`;
        }
        html += '</div>';
    } else {
        // Show button to generate structured info
        html += '<div class="preview-section preview-structured-empty">';
        html += '<div class="preview-text-header">LLM Summary</div>';
        html += `<p class="hint">No LLM summary available. <button class="btn btn-xs btn-llm" onclick="generateLlmInPreview(${entryId})">Generate with LLM</button></p>`;
        html += '</div>';
    }

    // Content Metadata section
    html += '<div class="preview-section">';
    html += '<div class="preview-text-header">Page Metadata</div>';
    html += '<div class="preview-meta">';
    html += `<div class="preview-meta-item"><strong>Provider:</strong> <span class="badge badge-provider">${escapeHtml(parseData.provider || 'unknown')}</span></div>`;
    if (parseData.title) {
        html += `<div class="preview-meta-item"><strong>Title:</strong> ${escapeHtml(parseData.title)}</div>`;
    }
    if (parseData.url) {
        html += `<div class="preview-meta-item"><strong>URL:</strong> <a href="${escapeHtml(parseData.url)}" target="_blank">${escapeHtml(parseData.url)}</a></div>`;
    }
    if (parseData.author) {
        html += `<div class="preview-meta-item"><strong>Author:</strong> ${escapeHtml(parseData.author)}</div>`;
    }
    
    // Provider-specific metadata
    if (parseData.raw_data) {
        if (parseData.provider === 'exa' && parseData.raw_data.cost_dollars) {
            html += `<div class="preview-meta-item"><strong>Cost:</strong> $${parseData.raw_data.cost_dollars.total.toFixed(4)}</div>`;
        }
        if (parseData.raw_data.search_time !== undefined) {
            html += `<div class="preview-meta-item"><strong>Fetch time:</strong> ${parseData.raw_data.search_time.toFixed(0)}ms</div>`;
        }
        if (parseData.provider === 'direct' && parseData.raw_data.html_length) {
            html += `<div class="preview-meta-item"><strong>HTML size:</strong> ${parseData.raw_data.html_length.toLocaleString()} chars</div>`;
        }
    }
    html += '</div>';
    html += '</div>';

    // Full Content section
    html += '<div class="preview-section">';
    html += '<div class="preview-text-header">Full Content</div>';
    if (parseData.text) {
        // Render text as Markdown
        html += `<div class="preview-text preview-markdown">${marked.parse(parseData.text)}</div>`;
    } else {
        html += '<div class="preview-text preview-empty">No text content available</div>';
    }
    html += '</div>';

    return html;
}

async function generateLlmInPreview(entryId) {
    const content = document.getElementById('preview-content');
    const originalHtml = content.innerHTML;
    
    // Update to show loading in the structured section
    const structuredSection = content.querySelector('.preview-structured-empty');
    if (structuredSection) {
        structuredSection.innerHTML = '<div class="preview-text-header">Structured Summary</div><p class="hint">Generating...</p>';
    }
    
    try {
        await apiCall(`/api/llm/struct/${entryId}`, { method: 'POST' });
        // Refresh the preview
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to generate: ' + error.message);
        content.innerHTML = originalHtml;
    }
}

async function rerunLlm(entryId) {
    if (!confirm('Re-run LLM extraction? This will overwrite the existing structure.')) return;
    
    const content = document.getElementById('preview-content');
    const structuredSection = content.querySelector('.preview-structured');
    if (structuredSection) {
        structuredSection.innerHTML = '<div class="preview-text-header">Structured Summary</div><p class="hint">Re-generating...</p>';
    }
    
    try {
        await apiCall(`/api/llm/struct/${entryId}?force=true`, { method: 'POST' });
        // Refresh the preview
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to re-run: ' + error.message);
        openPreview(entryId, true);
    }
}

async function saveUserType(entryId) {
    const typeSelect = document.getElementById(`type-select-${entryId}`);
    const reasonInput = document.getElementById(`type-reason-${entryId}`);
    
    const userType = typeSelect.value;
    const userReason = reasonInput.value.trim();
    
    if (!userType) {
        // If no type selected, clear instead
        await clearUserType(entryId);
        return;
    }
    
    try {
        const data = await apiCall(`/api/entries/${entryId}/type`, {
            method: 'PATCH',
            body: JSON.stringify({
                user_type: userType,
                user_reason: userReason || null,
            }),
        });
        
        // Update the badge in the card
        updateCardTypeBadge(entryId, data.effective_type);
        
        // Refresh the preview
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to save type: ' + error.message);
    }
}

async function clearUserType(entryId) {
    try {
        const data = await apiCall(`/api/entries/${entryId}/type/user`, {
            method: 'DELETE',
        });
        
        // Update the badge in the card
        updateCardTypeBadge(entryId, data.effective_type);
        
        // Refresh the preview
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to clear type: ' + error.message);
    }
}

async function saveTags(entryId) {
    const tagsInput = document.getElementById(`tags-input-${entryId}`);
    if (!tagsInput) return;
    
    // Parse comma-separated tags
    const tagNames = tagsInput.value
        .split(',')
        .map(t => t.trim())
        .filter(t => t.length > 0);
    
    try {
        const data = await apiCall(`/api/entries/${entryId}/tags`, {
            method: 'PUT',
            body: JSON.stringify({ tags: tagNames }),
        });
        
        // Refresh the preview to show updated tags
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to save tags: ' + error.message);
    }
}

async function addTags(entryId) {
    const tagsInput = document.getElementById(`tags-input-${entryId}`);
    if (!tagsInput) return;

    const tagNames = tagsInput.value
        .split(',')
        .map(t => t.trim())
        .filter(t => t.length > 0);

    if (tagNames.length === 0) return;

    try {
        await apiCall(`/api/entries/${entryId}/tags`, {
            method: 'POST',
            body: JSON.stringify({ tags: tagNames }),
        });
        tagsInput.value = '';
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to add tags: ' + error.message);
    }
}

async function removeTag(entryId, tagKey) {
    if (!tagKey) return;
    try {
        await apiCall(`/api/entries/${entryId}/tags/${encodeURIComponent(tagKey)}`, {
            method: 'DELETE',
        });
        openPreview(entryId, true);
    } catch (error) {
        alert('Failed to remove tag: ' + error.message);
    }
}

function updateCardTypeBadge(entryId, newType) {
    const card = document.querySelector(`.entry-card[data-entry-id="${entryId}"]`);
    if (!card) return;
    
    const badge = card.querySelector('[data-type-badge]');
    if (!badge) return;
    
    // Remove old type class
    badge.className = badge.className.replace(/badge-type-\w+/g, '');
    // Add new type class
    badge.classList.add(`badge-type-${newType}`);
    badge.textContent = newType;
    badge.title = `Article type: ${newType}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function closePreview() {
    const backdrop = document.getElementById('preview-backdrop');
    const drawer = document.getElementById('preview-drawer');
    
    // Close drawer with animation
    backdrop.classList.remove('is-open');
    drawer.classList.remove('is-open');
    document.body.classList.remove('preview-open');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape: close preview
    if (e.key === 'Escape') {
        closePreview();
        return;
    }
    
    // Skip if user is typing in an input/select/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
    }
    
    // Skip if preview drawer is open
    const drawer = document.getElementById('preview-drawer');
    if (drawer && !drawer.classList.contains('hidden')) {
        return;
    }
    
    // Arrow keys for pagination
    if (e.key === 'ArrowLeft') {
        const prevLink = document.querySelector('.pagination-actions a[data-direction="prev"][data-page]');
        if (prevLink && prevLink.dataset.page) {
            navigatePage(parseInt(prevLink.dataset.page, 10));
        }
    } else if (e.key === 'ArrowRight') {
        const nextLink = document.querySelector('.pagination-actions a[data-direction="next"][data-page]');
        if (nextLink && nextLink.dataset.page) {
            navigatePage(parseInt(nextLink.dataset.page, 10));
        }
    }
});
</script>
{% endblock %}
